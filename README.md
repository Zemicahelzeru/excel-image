<div class="header">
    <div class="container">
        <h1>Excel Image Extractor</h1>
    </div>
</div>

<div class="container">
    <div class="card">
        <div class="instructions">
            <h2>Instructions</h2>
            <ol>
                <li>Upload your Excel file containing images</li>
                <li>Select the sheet containing your images</li>
                <li>Paste Column A content into the grid below</li>
                <li>Validate and process</li>
            </ol>
        </div>
    </div>

    <div class="card">
        <div class="upload-form">
            <form id="uploadForm">
                <div class="file-input">
                    <label for="excelFile" class="sr-only">Excel file</label>
                    <input type="file" accept=".xlsx,.xlsm" required id="excelFile">
                </div>
                <button type="submit" class="button" id="uploadButton">Upload Excel File</button>
            </form>
        </div>

        <div class="sheet-selection" id="sheetSelection">
            <h3>Select Sheet</h3>
            <div class="sheet-list" id="sheetList"></div>
        </div>

        <!-- NEW: Excel-like Grid for Column A -->
        <div class="paste-image-column-section card" id="pasteImageColumnSection" style="display: none;">
            <h3>Step 3: Paste Column A (Image Column)</h3>
            <div class="instructions" style="margin: 15px 0;">
                <p><strong>Paste your image column here:</strong></p>
                <ol>
                    <li>Open your Excel file</li>
                    <li>Select Column A cells (from first row with data)</li>
                    <li>Copy (<kbd>Ctrl+C</kbd>)</li>
                    <li>Click in the grid below and paste (<kbd>Ctrl+V</kbd>)</li>
                </ol>
            </div>
            
            <!-- Excel-style Grid -->
            <div class="excel-grid-container">
                <table class="excel-grid" id="excelGrid">
                    <thead>
                        <tr>
                            <th class="row-header">Row</th>
                            <th class="col-header">Column A (Images)</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody">
                        <!-- Rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button type="button" class="button" id="validateImageColumnBtn">Validate</button>
                <button type="button" class="button btn-secondary" id="clearImageColumnBtn">Clear All</button>
            </div>
            
            <!-- Validation Preview -->
            <div id="imageColumnPreview" style="display: none; margin-top: 20px;">
                <div id="imageColumnStatus" class="status"></div>
                <div id="validationSummary" style="margin-top: 15px; background: #f9f9f9; border: 1px solid var(--rl-border); border-radius: 4px; padding: 15px; display: none;">
                    <h4 style="margin-top: 0; color: var(--rl-navy);">Summary</h4>
                    <div id="summaryDetails"></div>
                </div>
            </div>
        </div>

        <div class="spinner" id="spinner" aria-hidden="true"></div>
        <div class="progress-bar" id="progressBar" aria-hidden="true">
            <div class="progress" id="progress"></div>
        </div>
        <div id="status" class="status" role="status" aria-live="polite"></div>

        <div style="margin-top: 20px;">
            <button class="button" id="processButton" disabled>Process Selected Sheet</button>
        </div>
    </div>
</div>

<script src="script.js"></script>

:root {
    --rl-navy: #041E42;
    --rl-burgundy: #75263D;
    --rl-gray: #F5F5F5;
    --rl-border: #CCCCCC;
}

body {
    font-family: "Founders Grotesk", Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: var(--rl-gray);
    color: #333333;
}

.header {
    background: var(--rl-navy);
    color: #ffffff;
    padding: 20px 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 20px;
}

.card {
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin: 20px 0;
    padding: 20px;
}

.instructions {
    background: #E3F2FD;
    border-left: 4px solid #2196F3;
    padding: 15px;
    margin: 20px 0;
    border-radius: 4px;
}

.instructions h2 {
    margin-top: 0;
    color: var(--rl-navy);
}

.instructions h4 {
    margin: 10px 0 5px 0;
    color: var(--rl-navy);
}

.instructions ol {
    padding-left: 20px;
}

.instructions li {
    margin: 10px 0;
}

.instructions p {
    margin: 8px 0;
}

.upload-form {
    border: 2px dashed var(--rl-border);
    padding: 30px;
    text-align: center;
    margin: 20px 0;
    border-radius: 8px;
    background: #ffffff;
}

.sheet-selection {
    display: none;
    margin: 20px 0;
}

.sheet-selection h3 {
    color: var(--rl-navy);
    margin-bottom: 15px;
}

.sheet-list {
    margin: 10px 0;
    max-height: 200px;
    overflow-y: auto;
}

.sheet-option {
    padding: 10px;
    margin: 5px 0;
    border: 1px solid var(--rl-border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.sheet-option:hover {
    background: var(--rl-gray);
}

.sheet-option.selected {
    background: var(--rl-navy);
    color: #ffffff;
    border-color: var(--rl-navy);
}

/* NEW: Paste Image Column Section */
.paste-image-column-section {
    border: 2px solid #2196F3;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
    background: #f0f7ff;
}

.paste-image-column-section h3 {
    color: var(--rl-navy);
    margin-top: 0;
    border-bottom: 2px solid #2196F3;
    padding-bottom: 10px;
}

#imageColumnTextarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--rl-border);
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.95em;
    line-height: 1.5;
    resize: vertical;
    box-sizing: border-box;
}

#imageColumnTextarea:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 4px rgba(33, 150, 243, 0.3);
}

#imageColumnTextarea::placeholder {
    color: #999;
    font-size: 0.9em;
}

.button {
    background: var(--rl-navy);
    color: #ffffff;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
    font-weight: 500;
}

.button:hover {
    background: #0a2e5c;
}

.button:disabled {
    background: var(--rl-border);
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-secondary {
    background: #757575;
    color: #ffffff;
}

.btn-secondary:hover {
    background: #616161;
}

.file-input {
    margin-bottom: 15px;
}

.status {
    margin: 20px 0;
    padding: 15px;
    border-radius: 4px;
    min-height: 24px;
    display: none;
}

.status.error {
    background: #FFEBEE;
    color: #C62828;
    border-left: 4px solid #C62828;
    display: block;
}

.status.success {
    background: #E8F5E9;
    color: #2E7D32;
    border-left: 4px solid #2E7D32;
    display: block;
}

.status.info {
    background: #E3F2FD;
    color: #0D47A1;
    border-left: 4px solid #1976D2;
    display: block;
}

.status-message {
    margin: 0;
    font-weight: 500;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background: var(--rl-gray);
    margin: 20px 0;
    display: none;
    border-radius: 2px;
}

.progress {
    width: 0%;
    height: 100%;
    background: var(--rl-navy);
    transition: width 0.3s ease;
    border-radius: 2px;
}

.spinner {
    display: none;
    width: 30px;
    height: 30px;
    border: 3px solid var(--rl-gray);
    border-top: 3px solid var(--rl-navy);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

/* Image Column Preview Styles */
#imageColumnDetails {
    background: #ffffff;
    border: 1px solid var(--rl-border);
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}

#imageColumnDetailsList {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.6;
    color: #333;
}

.image-row-item {
    padding: 8px;
    margin: 4px 0;
    border-left: 3px solid #2196F3;
    background: #f9f9f9;
    border-radius: 2px;
}

.image-row-item.empty {
    border-left-color: #FF9800;
    background: #fff3e0;
}

.image-row-item.has-content {
    border-left-color: #4CAF50;
    background: #f1f8e9;
}

.image-row-label {
    font-weight: bold;
    color: var(--rl-navy);
    margin-right: 8px;
}

.image-row-value {
    color: #666;
    word-break: break-all;
    white-space: pre-wrap;
}

/* Validation Summary */
.validation-summary {
    background: #f5f5f5;
    border: 1px solid var(--rl-border);
    border-radius: 4px;
    padding: 12px;
    margin-top: 12px;
    font-size: 0.95em;
}

.validation-summary-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid #ddd;
}

.validation-summary-item:last-child {
    border-bottom: none;
}

.validation-summary-label {
    font-weight: 500;
    color: var(--rl-navy);
}

.validation-summary-value {
    color: #666;
    font-weight: bold;
}

/* Button Group */
[style*="display: flex"][style*="gap: 10px"] {
    flex-wrap: wrap;
}

[style*="display: flex"][style*="gap: 10px"] .button {
    flex: 1;
    min-width: 150px;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

/* Excel Grid Styles */
.excel-grid-container {
    margin: 15px 0;
    border: 1px solid var(--rl-border);
    border-radius: 4px;
    overflow: hidden;
    background: #ffffff;
}

.excel-grid {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Courier New', monospace;
    font-size: 13px;
}

.excel-grid thead {
    background: var(--rl-navy);
    color: #ffffff;
    position: sticky;
    top: 0;
}

.excel-grid th {
    padding: 10px;
    text-align: left;
    font-weight: bold;
    border-right: 1px solid #ddd;
}

.excel-grid th.row-header {
    width: 60px;
    text-align: center;
}

.excel-grid th.col-header {
    flex: 1;
}

.excel-grid tbody {
    max-height: 400px;
    overflow-y: auto;
    display: block;
}

.excel-grid thead,
.excel-grid tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
}

.excel-grid td {
    padding: 0;
    border-right: 1px solid var(--rl-border);
    border-bottom: 1px solid var(--rl-border);
}

.excel-grid td.row-num {
    background: #f5f5f5;
    color: #666;
    text-align: center;
    font-weight: bold;
    width: 60px;
    padding: 8px;
    user-select: none;
}

.excel-grid input {
    width: 100%;
    border: none;
    padding: 8px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
}

.excel-grid input:focus {
    outline: 2px solid #2196F3;
    outline-offset: -1px;
    background: #e3f2fd;
}

.excel-grid input.has-content {
    background: #f1f8e9;
}

.excel-grid input.empty {
    background: #ffffff;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 15px;
    }

    .card {
        padding: 15px;
        margin: 15px 0;
    }

    .button {
        padding: 10px 20px;
        font-size: 14px;
    }

    .instructions ol {
        padding-left: 18px;
    }

    .instructions li {
        margin: 8px 0;
    }

    #imageColumnTextarea {
        font-size: 14px;
    }

    .sheet-list {
        max-height: 150px;
    }
}




(function () {
  "use strict";

  function apiUrl(path) {
    const normalized = path.startsWith("/") ? path : "/" + path;
    if (typeof getWebAppBackendUrl === "function") {
      return getWebAppBackendUrl(normalized);
    }
    return "backend" + normalized;
  }

  function init() {
    const uploadForm = document.getElementById("uploadForm");
    const sheetSelection = document.getElementById("sheetSelection");
    const sheetList = document.getElementById("sheetList");
    const pasteImageColumnSection = document.getElementById("pasteImageColumnSection");
    const imageColumnTextarea = document.getElementById("imageColumnTextarea");
    const validateImageColumnBtn = document.getElementById("validateImageColumnBtn");
    const clearImageColumnBtn = document.getElementById("clearImageColumnBtn");
    const imageColumnPreview = document.getElementById("imageColumnPreview");
    const imageColumnStatus = document.getElementById("imageColumnStatus");
    const imageColumnDetails = document.getElementById("imageColumnDetails");
    const imageColumnDetailsList = document.getElementById("imageColumnDetailsList");
    const processButton = document.getElementById("processButton");
    const spinner = document.getElementById("spinner");
    const progressBar = document.getElementById("progressBar");
    const progress = document.getElementById("progress");
    const status = document.getElementById("status");
    const uploadButton = document.getElementById("uploadButton");
    const excelFileInput = document.getElementById("excelFile");
      
    // ADD THIS INSIDE THE init() FUNCTION after variable declarations

const excelGridBody = document.getElementById("gridBody");
const validateImageColumnBtn = document.getElementById("validateImageColumnBtn");
const clearImageColumnBtn = document.getElementById("clearImageColumnBtn");

let gridRows = 100; // Number of rows in grid
let validatedData = null;

// Initialize grid with empty rows
function initializeGrid() {
    excelGridBody.innerHTML = "";
    for (let i = 1; i <= gridRows; i++) {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="row-num">${i}</td>
            <td><input type="text" class="grid-cell" data-row="${i}" placeholder="Row ${i}"></td>
        `;
        excelGridBody.appendChild(row);
    }

    // Add paste handler to grid
    document.addEventListener("paste", function(e) {
        const activeEl = document.activeElement;
        if (activeEl.classList.contains("grid-cell")) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData("text");
            const lines = pastedText.split("\n");
            const startRow = parseInt(activeEl.dataset.row);

            lines.forEach((line, idx) => {
                const rowNum = startRow + idx;
                const cell = document.querySelector(`.grid-cell[data-row="${rowNum}"]`);
                if (cell) {
                    cell.value = line.trim();
                    cell.classList.toggle("has-content", !!line.trim());
                    cell.classList.toggle("empty", !line.trim());
                }
            });
        }
    });
}

// Validate button
validateImageColumnBtn.addEventListener("click", function() {
    const cells = document.querySelectorAll(".grid-cell");
    let imageData = [];
    let rowsWithContent = 0;
    let emptyRows = 0;

    cells.forEach(cell => {
        const value = cell.value.trim();
        const rowNum = parseInt(cell.dataset.row);
        
        if (value) {
            rowsWithContent++;
        } else {
            emptyRows++;
        }

        imageData.push({
            row: rowNum,
            value: value,
            has_content: !!value
        });
    });

    // Show validation results
    imageColumnStatus.className = "status success";
    imageColumnStatus.innerHTML = `
        <div class="status-message">
            ✅ Found ${imageData.length} rows with ${rowsWithContent} containing images
        </div>
    `;

    const summaryHtml = `
        <div class="validation-summary">
            <div class="validation-summary-item">
                <span class="validation-summary-label">Total rows:</span>
                <span class="validation-summary-value">${imageData.length}</span>
            </div>
            <div class="validation-summary-item">
                <span class="validation-summary-label">Rows with images:</span>
                <span class="validation-summary-value">${rowsWithContent}</span>
            </div>
            <div class="validation-summary-item">
                <span class="validation-summary-label">Empty rows:</span>
                <span class="validation-summary-value">${emptyRows}</span>
            </div>
        </div>
    `;

    document.getElementById("summaryDetails").innerHTML = summaryHtml;
    document.getElementById("validationSummary").style.display = "block";
    imageColumnPreview.style.display = "block";

    validatedData = imageData;
    processButton.disabled = false;
    showStatus("✅ Image column validated. Ready to process!", "success");
});

// Clear button
clearImageColumnBtn.addEventListener("click", function() {
    document.querySelectorAll(".grid-cell").forEach(cell => {
        cell.value = "";
        cell.classList.remove("has-content");
        cell.classList.add("empty");
    });
    imageColumnPreview.style.display = "none";
    validatedData = null;
    processButton.disabled = true;
    clearStatus();
});

// Initialize grid when section shows
function showGridSection() {
    pasteImageColumnSection.style.display = "block";
    if (excelGridBody.children.length === 0) {
        initializeGrid();
    }
}

    if (
      !uploadForm ||
      !sheetSelection ||
      !sheetList ||
      !processButton ||
      !spinner ||
      !progressBar ||
      !progress ||
      !status ||
      !uploadButton ||
      !excelFileInput ||
      !pasteImageColumnSection ||
      !imageColumnTextarea ||
      !validateImageColumnBtn
    ) {
      return;
    }

    let progressInterval = null;
    let selectedSheet = null;
    let excelFileData = null;
    let validatedImageColumn = null;

    function showStatus(message, type) {
      const statusType = type || "info";
      status.className = "status " + statusType;
      status.innerHTML =
        '<div class="status-message">' +
        (statusType === "error" ? "❌ " : statusType === "success" ? "✅ " : "ℹ️ ") +
        message +
        "</div>";
    }

    function clearStatus() {
      status.className = "status";
      status.textContent = "";
    }

    function showSpinner() {
      spinner.style.display = "block";
    }

    function hideSpinner() {
      spinner.style.display = "none";
    }

    function showProgressBar() {
      if (progressInterval) {
        clearInterval(progressInterval);
      }

      progressBar.style.display = "block";
      progress.style.width = "0%";

      let width = 0;
      progressInterval = setInterval(function () {
        if (width >= 90) {
          clearInterval(progressInterval);
          progressInterval = null;
          return;
        }
        width += 1;
        progress.style.width = width + "%";
      }, 50);
    }

    function hideProgressBar() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      progress.style.width = "100%";
      setTimeout(function () {
        progressBar.style.display = "none";
        progress.style.width = "0%";
      }, 400);
    }

    function parseError(response) {
      return response
        .clone()
        .json()
        .then(function (body) {
          return body.message || body.error || JSON.stringify(body);
        })
        .catch(function () {
          return response
            .clone()
            .text()
            .then(function (text) {
              return text || ("Request failed (" + response.status + ")");
            })
            .catch(function () {
              return "Request failed (" + response.status + ")";
            });
        });
    }

    function friendlyErrorMessage(error, phase) {
      const message = (error && error.message) || String(error || "");
      if (/Failed to fetch/i.test(message)) {
        return (
          "Cannot reach backend during " +
          phase +
          ". In Dataiku this usually means backend crash, backend timeout, or backend restart. " +
          "Open webapp backend logs and restart the backend."
        );
      }
      return message || "Unexpected error";
    }

    function resetSheetSelection() {
      sheetSelection.style.display = "none";
      sheetList.innerHTML = "";
      pasteImageColumnSection.style.display = "none";
      imageColumnTextarea.value = "";
      validatedImageColumn = null;
      processButton.disabled = true;
    }

    function showSheetSelection(sheets) {
      sheetList.innerHTML = "";
      sheets.forEach(function (sheet) {
        const option = document.createElement("div");
        option.className = "sheet-option";
        option.textContent = sheet;

    // REPLACE WITH THIS NEW CODE:
option.addEventListener("click", function () {
    document.querySelectorAll(".sheet-option").forEach(function (el) {
        el.classList.remove("selected");
    });
    option.classList.add("selected");
    selectedSheet = sheet;
    
    // Show the Excel grid section
    showGridSection();
    
    imageColumnPreview.style.display = "none";
    validatedData = null;
    processButton.disabled = true;
    
    showStatus("Sheet selected. Now paste Column A data into the grid.", "info");
});

        sheetList.appendChild(option);
      });
      sheetSelection.style.display = "block";
    }

    function getSheets(formData) {
      return fetch(apiUrl("/get_sheets"), {
        method: "POST",
        body: formData,
        credentials: "same-origin",
        cache: "no-store",
      }).then(
        function (response) {
          if (!response.ok) {
            return parseError(response).then(function (message) {
              throw new Error(message);
            });
          }
          return response.json();
        }
      );
    }

    function validateImageColumn(formData, imageColumnContent) {
      return fetch(apiUrl("/validate_image_column"), {
        method: "POST",
        body: formData,
        credentials: "same-origin",
        cache: "no-store",
        headers: {
          "X-Image-Column": encodeURIComponent(imageColumnContent),
        },
      }).then(
        function (response) {
          if (!response.ok) {
            return parseError(response).then(function (message) {
              throw new Error(message);
            });
          }
          return response.json();
        }
      );
    }

    function extractImages(formData) {
      return fetch(apiUrl("/extract_images"), {
        method: "POST",
        body: formData,
        credentials: "same-origin",
        cache: "no-store",
      }).then(
        function (response) {
          if (!response.ok) {
            return parseError(response).then(function (message) {
              throw new Error(message);
            });
          }
          const contentDisposition = response.headers.get("Content-Disposition") || "";
          const filenameMatch = contentDisposition.match(/filename\*?=(?:UTF-8''|")?([^\";]+)/i);
          const filename = filenameMatch ? decodeURIComponent(filenameMatch[1]).replace(/"/g, "") : "";
          return response.blob().then(function (blob) {
            return { blob: blob, filename: filename };
          });
        }
      );
    }

    function buildDownloadName(excelFilename, backendFilename) {
      if (backendFilename) {
        return backendFilename;
      }
      if (!excelFilename) {
        return "Excel_Images.zip";
      }
      const base = excelFilename.replace(/\.(xlsx|xlsm)$/i, "");
      return base + ".zip";
    }

    function runHealthCheck() {
      fetch(apiUrl("/health"), { credentials: "same-origin", cache: "no-store" })
        .then(function (response) {
          if (!response.ok) {
            throw new Error("Health check failed");
          }
          return response.json();
        })
        .then(function (data) {
          if (data.status !== "ok") {
            showStatus("Warning: Backend health check returned unexpected status.", "error");
          }
        })
        .catch(function () {
          showStatus("Warning: Cannot connect to backend. Check your webapp backend logs.", "error");
        });
    }

    // Image Column Validation Handler
    function displayValidationResults(data) {
      imageColumnStatus.className = "status " + (data.status === "ok" ? "success" : "error");
      imageColumnStatus.innerHTML =
        '<div class="status-message">' +
        (data.status === "ok" ? "✅ " : "❌ ") +
        data.message +
        "</div>";

      if (data.status === "ok" && data.details) {
        // Show details
        imageColumnDetailsList.innerHTML = "";
        data.details.items.forEach(function (item) {
          const div = document.createElement("div");
          div.className = "image-row-item " + (item.has_content ? "has-content" : "empty");
          div.innerHTML =
            '<span class="image-row-label">Row ' +
            item.row +
            ":</span>" +
            '<span class="image-row-value">' +
            (item.value ? escapeHtml(item.value) : "[EMPTY]") +
            "</span>";
          imageColumnDetailsList.appendChild(div);
        });

        // Show summary
        const summary = document.createElement("div");
        summary.className = "validation-summary";
        summary.innerHTML =
          '<div class="validation-summary-item">' +
          '<span class="validation-summary-label">Total rows:</span>' +
          '<span class="validation-summary-value">' +
          data.details.total_rows +
          "</span>" +
          "</div>" +
          '<div class="validation-summary-item">' +
          '<span class="validation-summary-label">Rows with images:</span>' +
          '<span class="validation-summary-value">' +
          data.details.rows_with_images +
          "</span>" +
          "</div>" +
          '<div class="validation-summary-item">' +
          '<span class="validation-summary-label">Empty rows:</span>' +
          '<span class="validation-summary-value">' +
          data.details.empty_rows +
          "</span>" +
          "</div>";
        imageColumnDetailsList.appendChild(summary);

        imageColumnDetails.style.display = "block";

        // Enable process button if validation passed
        if (data.status === "ok") {
          validatedImageColumn = data.image_column_data;
          processButton.disabled = false;
          showStatus("✅ Image column validated. Ready to process!", "success");
        }
      } else {
        imageColumnDetails.style.display = "none";
        processButton.disabled = true;
      }

      imageColumnPreview.style.display = "block";
    }

    // Event Listeners
    excelFileInput.addEventListener("change", function (event) {
      const file = event.target.files && event.target.files[0];
      uploadButton.textContent = file ? "Upload: " + file.name : "Upload Excel File";
      resetSheetSelection();
      clearStatus();
    });

    uploadForm.addEventListener("submit", function (event) {
      event.preventDefault();
      resetSheetSelection();
      clearStatus();

      const file = excelFileInput.files && excelFileInput.files[0];
      if (!file) {
        showStatus("Please select an Excel file.", "error");
        return;
      }

      if (!/\.(xlsx|xlsm)$/i.test(file.name)) {
        showStatus("Please upload a valid Excel file (.xlsx or .xlsm).", "error");
        return;
      }

      if (file.size > 50 * 1024 * 1024) {
        showStatus("File too large. Please upload a file up to 50MB.", "error");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);
      excelFileData = formData;

      uploadButton.disabled = true;
      showSpinner();
      showStatus("Reading Excel file...", "info");

      getSheets(formData)
        .then(function (data) {
          if (!Array.isArray(data.sheets) || data.sheets.length === 0) {
            throw new Error("No sheets found in the Excel file.");
          }
          showSheetSelection(data.sheets);
          showStatus("Select a sheet containing images.", "info");
        })
        .catch(function (error) {
          showStatus("Error: " + friendlyErrorMessage(error, "sheet loading"), "error");
          console.error("get_sheets error:", error);
        })
        .finally(function () {
          hideSpinner();
          uploadButton.disabled = false;
        });
    });

    validateImageColumnBtn.addEventListener("click", function () {
      const imageColumnContent = imageColumnTextarea.value.trim();

      if (!imageColumnContent) {
        showStatus("Please paste the content of Column A first.", "error");
        return;
      }

      if (!selectedSheet) {
        showStatus("Please select a sheet first.", "error");
        return;
      }

      validateImageColumnBtn.disabled = true;
      showSpinner();
      showStatus("Validating image column...", "info");

      const formData = new FormData();
      const file = excelFileInput.files && excelFileInput.files[0];
      if (file) {
        formData.append("file", file);
      }
      formData.append("sheet_name", selectedSheet);
      formData.append("image_column_content", imageColumnContent);

      validateImageColumn(formData, imageColumnContent)
        .then(function (data) {
          displayValidationResults(data);
        })
        .catch(function (error) {
          showStatus("Error validating image column: " + friendlyErrorMessage(error, "validation"), "error");
          console.error("validate_image_column error:", error);
          imageColumnPreview.style.display = "block";
          imageColumnStatus.className = "status error";
          imageColumnStatus.innerHTML =
            '<div class="status-message">❌ Validation failed. Please check your input and try again.</div>';
          imageColumnDetails.style.display = "none";
          processButton.disabled = true;
        })
        .finally(function () {
          hideSpinner();
          validateImageColumnBtn.disabled = false;
        });
    });

    clearImageColumnBtn.addEventListener("click", function () {
      imageColumnTextarea.value = "";
      imageColumnPreview.style.display = "none";
      validatedImageColumn = null;
      processButton.disabled = true;
      clearStatus();
      imageColumnTextarea.focus();
    });

    processButton.addEventListener("click", function () {
      if (!selectedSheet) {
        showStatus("Please select a sheet.", "error");
        return;
      }

      if (!validatedImageColumn) {
        showStatus("Please validate the image column first.", "error");
        return;
      }

      const file = excelFileInput.files && excelFileInput.files[0];
      if (!file) {
        showStatus("Please upload an Excel file first.", "error");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);
      formData.append("sheet_name", selectedSheet);
      formData.append("validated_image_column", JSON.stringify(validatedImageColumn));

      processButton.disabled = true;
      showSpinner();
      showProgressBar();
      showStatus("Processing images...", "info");

      extractImages(formData)
        .then(function (result) {
          const url = window.URL.createObjectURL(result.blob);
          const anchor = document.createElement("a");
          anchor.href = url;
          anchor.download = buildDownloadName(file.name, result.filename);
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);
          window.URL.revokeObjectURL(url);
          showStatus("✅ Images extracted successfully! Check your Downloads folder.", "success");
        })
        .catch(function (error) {
          showStatus("Error: " + friendlyErrorMessage(error, "image extraction"), "error");
          console.error("extract_images error:", error);
        })
        .finally(function () {
          hideSpinner();
          hideProgressBar();
          processButton.disabled = false;
        });
    });

    runHealthCheck();
  }

  function escapeHtml(text) {
    const map = {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;",
    };
    return String(text).replace(/[&<>"']/g, function (s) {
      return map[s];
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
